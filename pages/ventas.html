<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventas - CAFI POS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/ventas.css">
</head>
<body>
    <div class="admin-layout">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <span>CAFI</span>
            </div>
            <nav class="sidebar-nav">
                 <a href="pos.html" class="nav-item"><i class="fas fa-cash-register"></i><span>Punto de Venta</span></a>
                <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i><span>Dashboard</span></a>
                    <a href="productos.html" class="nav-item"><i class="fas fa-box"></i><span>Productos</span></a>
                <a href="clientes.html" class="nav-item"><i class="fas fa-users"></i><span>Clientes</span></a>
                <a href="compras.html" class="nav-item"><i class="fas fa-shopping-cart"></i><span>Compras</span></a>
                <a href="inventario.html" class="nav-item"><i class="fas fa-boxes"></i><span>Inventario</span></a>
                   <a href="ventas.html" class="nav-item active"><i class="fas fa-file-invoice-dollar"></i><span>Ventas</span></a>
                <a href="reportes.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Reportes</span></a>
                            <a href="gastos.html" class="nav-item"><i class="fas fa-chart-bar"></i><span>Gastos</span></a>
                <a href="configuracion.html" class="nav-item"><i class="fas fa-cog"></i><span>Configuración</span></a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-mini">
                    <div class="user-avatar" id="userAvatar">US</div>
                    <div class="user-info">
                        <span id="userName">Usuario</span>
                        <small id="userSucursal">Sucursal</small>
                    </div>
                </div>
                <button class="btn-logout" onclick="location.href='login.html'" title="Cerrar sesión">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </aside>

        <!-- MAIN -->
        <main class="admin-main">
            <header class="admin-header">
                <h1><i class="fas fa-file-invoice-dollar"></i> Ventas</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="limpiarFormulario()">
                        <i class="fas fa-plus"></i> Nueva Venta
                    </button>
                </div>
            </header>

            <div class="admin-content">
                <!-- TABS -->
                <div class="tabs-container">
                    <nav class="tabs-nav">
                        <button class="tab-btn active" data-tab="crear"><i class="fas fa-plus-circle"></i> Crear Venta</button>
                        <button class="tab-btn" data-tab="ventas"><i class="fas fa-list"></i> Lista de Ventas</button>
                        <button class="tab-btn" data-tab="devoluciones"><i class="fas fa-undo"></i> Devoluciones</button>
                    </nav>
                </div>

                <div class="content-wrapper">
                    <!-- ==================== TAB CREAR ==================== -->
                    <div class="tab-panel active" id="panel-crear">
                        <div class="form-card">
                            <!-- Status Bar -->
                            <div class="statusbar">
                                <div class="statusbar-left">
                                    <div class="statusbar-steps">
                                        <span class="step active" data-status="BORRADOR"><i class="fas fa-edit"></i> Borrador</span>
                                        <i class="fas fa-chevron-right step-arrow"></i>
                                        <span class="step" data-status="CONFIRMADA"><i class="fas fa-check"></i> Confirmada</span>
                                        <i class="fas fa-chevron-right step-arrow"></i>
                                        <span class="step" data-status="PAGADA"><i class="fas fa-dollar-sign"></i> Pagada</span>
                                    </div>
                                    <span class="folio-badge" id="ventaFolio"></span>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="action-buttons">
                                <button class="btn btn-outline" id="btnGuardar" onclick="guardarVenta('BORRADOR')">
                                    <i class="fas fa-save"></i> Guardar Borrador
                                </button>
                                <button class="btn btn-success" id="btnConfirmar" onclick="guardarVenta('CONFIRMADA')">
                                    <i class="fas fa-check"></i> Confirmar
                                </button>
                                <button class="btn btn-primary" id="btnCobrar" onclick="abrirModalCobro()" style="display:none">
                                    <i class="fas fa-dollar-sign"></i> Cobrar
                                </button>
                                <button class="btn btn-outline" id="btnPDF" onclick="generarPDF()" style="display:none">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <button class="btn btn-warning" id="btnReabrir" onclick="reabrirVenta()" style="display:none">
                                    <i class="fas fa-lock-open"></i> Reabrir
                                </button>
                                <button class="btn btn-danger" id="btnCancelar" onclick="cancelarVentaActual()" style="display:none">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                <input type="hidden" id="ventaId">
                            </div>

                            <!-- Fields -->
                            <div class="fields-grid">
                                <div class="field">
                                    <label>Cliente <span class="required">*</span></label>
                                    <div class="field-with-btn">
                                        <select id="ventaCliente"></select>
                                        <button class="btn-add-inline" onclick="abrirModal('modalCliente')" title="Nuevo cliente">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Almacén <span class="required">*</span></label>
                                    <select id="ventaAlmacen"></select>
                                </div>
                                <div class="field">
                                    <label>Fecha</label>
                                    <input type="date" id="ventaFecha">
                                </div>
                                <div class="field">
                                    <label>Tipo de Venta</label>
                                    <select id="ventaTipo">
                                        <option value="CONTADO">Contado</option>
                                        <option value="CREDITO">Crédito</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label>Descuento Global %</label>
                                    <input type="number" id="ventaDescuentoGlobal" value="0" min="0" max="100" step="0.01" oninput="aplicarDescuentoGlobal()">
                                </div>
                                <div class="field">
                                    <label>Vendedor</label>
                                    <select id="ventaVendedor"></select>
                                </div>
                                <div class="field half">
                                    <label>Notas</label>
                                    <textarea id="ventaNotas" rows="2" placeholder="Observaciones..."></textarea>
                                </div>
                            </div>

                            <!-- Lines Table -->
                            <div class="lines-section">
                                <table class="lines-table">
                                    <thead>
                                        <tr>
                                            <th style="width:32%">Producto</th>
                                            <th style="width:10%">Cantidad</th>
                                            <th style="width:7%">Unidad</th>
                                            <th style="width:12%">Precio Unit.</th>
                                            <th style="width:9%">Desc %</th>
                                            <th style="width:10%">Desc $</th>
                                            <th style="width:12%">Importe</th>
                                            <th style="width:8%"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaLineas"></tbody>
                                </table>
                                <div class="lines-actions">
                                    <a class="line-link" onclick="agregarLineaVacia()"><i class="fas fa-plus"></i> Agregar línea</a>
                                    <a class="line-link" onclick="abrirCatalogo()"><i class="fas fa-th"></i> Catálogo</a>
                                </div>
                            </div>

                            <!-- Totals -->
                            <div class="totals-section">
                                <div class="totals-box">
                                    <div class="total-row">
                                        <span>Subtotal:</span>
                                        <span id="ventaSubtotal">$0.00</span>
                                    </div>
                                    <div class="total-row">
                                        <span>Descuento:</span>
                                        <span id="ventaDescuento" class="text-danger">-$0.00</span>
                                    </div>
                                    <div class="total-row">
                                        <span>IVA:</span>
                                        <span id="ventaIVA">$0.00</span>
                                    </div>
                                    <div class="total-row final">
                                        <span>TOTAL:</span>
                                        <span id="ventaTotal">$0.00</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Historial Pagos -->
                            <div class="historial-section" id="seccionPagos" style="display:none">
                                <h4><i class="fas fa-history"></i> Historial de Pagos <span class="saldo-badge" id="saldoPendiente">Saldo: $0.00</span></h4>
                                <div class="pagos-list" id="listaPagos"></div>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== TAB LISTA VENTAS ==================== -->
                    <div class="tab-panel" id="panel-ventas">
                        <div class="stats-row">
                            <div class="mini-stat">
                                <i class="fas fa-file-invoice"></i>
                                <div class="mini-stat-info">
                                    <span class="mini-stat-value" id="statVentas">0</span>
                                    <span class="mini-stat-label">Ventas</span>
                                </div>
                            </div>
                            <div class="mini-stat success">
                                <i class="fas fa-dollar-sign"></i>
                                <div class="mini-stat-info">
                                    <span class="mini-stat-value" id="statTotal">$0.00</span>
                                    <span class="mini-stat-label">Total</span>
                                </div>
                            </div>
                            <div class="mini-stat warning">
                                <i class="fas fa-clock"></i>
                                <div class="mini-stat-info">
                                    <span class="mini-stat-value" id="statPendiente">$0.00</span>
                                    <span class="mini-stat-label">Pendiente</span>
                                </div>
                            </div>
                            <div class="mini-stat danger">
                                <i class="fas fa-times-circle"></i>
                                <div class="mini-stat-info">
                                    <span class="mini-stat-value" id="statCanceladas">0</span>
                                    <span class="mini-stat-label">Canceladas</span>
                                </div>
                            </div>
                        </div>

                        <div class="filters-bar">
                            <div class="filter-item">
                                <label>Desde</label>
                                <input type="date" id="filtroDesde">
                            </div>
                            <div class="filter-item">
                                <label>Hasta</label>
                                <input type="date" id="filtroHasta">
                            </div>
                            <div class="filter-item">
                                <label>Cliente</label>
                                <select id="filtroCliente"><option value="">Todos</option></select>
                            </div>
                            <div class="filter-item">
                                <label>Estatus</label>
                                <select id="filtroEstatus">
                                    <option value="">Todos</option>
                                    <option value="BORRADOR">Borrador</option>
                                    <option value="PENDIENTE">Confirmada</option>
                                    <option value="PAGADA">Pagada</option>
                                    <option value="CANCELADA">Cancelada</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label>Tipo</label>
                                <select id="filtroTipo">
                                    <option value="">Todos</option>
                                    <option value="CONTADO">Contado</option>
                                    <option value="CREDITO">Crédito</option>
                                </select>
                            </div>
                            <button class="btn-filtrar" onclick="cargarVentas()"><i class="fas fa-search"></i> Buscar</button>
                        </div>

                        <div class="panel-table">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Folio</th>
                                        <th>Cliente</th>
                                        <th>Fecha</th>
                                        <th>Tipo</th>
                                        <th class="text-right">Total</th>
                                        <th class="text-right">Saldo</th>
                                        <th class="text-center">Estatus</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaVentas"></tbody>
                            </table>
                            <div class="empty-state" id="emptyVentas">
                                <i class="fas fa-file-invoice"></i>
                                <h4>No hay ventas</h4>
                                <p>Las ventas aparecerán aquí</p>
                            </div>
                        </div>

                        <div class="panel-footer">
                            <span id="totalVentas">0 ventas</span>
                            <div class="export-btns">
                                <button class="btn-export" onclick="exportarVentas()"><i class="fas fa-file-excel"></i> Excel</button>
                                <button class="btn-print" onclick="imprimirLista()"><i class="fas fa-print"></i> Imprimir</button>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== TAB DEVOLUCIONES ==================== -->
                    <div class="tab-panel" id="panel-devoluciones">
                        <div class="filters-bar">
                            <div class="filter-item">
                                <label>Desde</label>
                                <input type="date" id="filtroDevDesde">
                            </div>
                            <div class="filter-item">
                                <label>Hasta</label>
                                <input type="date" id="filtroDevHasta">
                            </div>
                            <button class="btn-filtrar" onclick="cargarDevoluciones()"><i class="fas fa-search"></i> Buscar</button>
                        </div>

                        <div class="panel-table">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Venta Original</th>
                                        <th>Cliente</th>
                                        <th class="text-right">Monto</th>
                                        <th>Método</th>
                                        <th>Motivo</th>
                                        <th>Usuario</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaDevoluciones"></tbody>
                            </table>
                            <div class="empty-state" id="emptyDevoluciones">
                                <i class="fas fa-undo"></i>
                                <h4>No hay devoluciones</h4>
                                <p>Las devoluciones aparecerán aquí</p>
                            </div>
                        </div>

                        <div class="panel-footer">
                            <span id="totalDevoluciones">0 devoluciones</span>
                            <span class="total-sum" id="sumaDevoluciones">Total: $0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ==================== MODALES ==================== -->

    <!-- Modal Cobro -->
    <div class="modal-overlay" id="modalCobro">
        <div class="modal modal-md">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-dollar-sign"></i> Cobrar Venta</div>
                <button class="btn-close" onclick="cerrarModal('modalCobro')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="cobro-total-display">
                    <span>Total a Cobrar</span>
                    <strong id="cobroTotal">$0.00</strong>
                </div>
                <div class="cobro-saldo" id="cobroSaldoBox" style="display:none">
                    <span>Saldo pendiente:</span>
                    <strong id="cobroSaldo">$0.00</strong>
                </div>
                
                <div class="metodos-pago-grid" id="metodosPagoGrid"></div>
                
                <div class="pago-detalle" id="pagoDetalle">
                    <div class="form-group">
                        <label>Monto a pagar</label>
                        <input type="number" id="cobroMonto" step="0.01" min="0" oninput="calcularCambio()">
                    </div>
                    <div class="form-group" id="grupoReferencia" style="display:none">
                        <label>Referencia</label>
                        <input type="text" id="cobroReferencia" placeholder="Número de referencia">
                    </div>
                </div>

                <div class="cobro-cambio" id="cobroCambioBox">
                    <span>Cambio:</span>
                    <strong id="cobroCambio">$0.00</strong>
                </div>

                <div class="multi-pagos" id="multiPagos" style="display:none">
                    <h5><i class="fas fa-layer-group"></i> Pagos Aplicados</h5>
                    <div class="pagos-aplicados" id="pagosAplicados"></div>
                    <div class="pagos-resumen">
                        <span>Total pagado: <strong id="totalPagado">$0.00</strong></span>
                        <span>Resta: <strong id="restaPagar">$0.00</strong></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="agregarPagoMultiple()"><i class="fas fa-plus"></i> Agregar Pago</button>
                <button class="btn btn-success btn-lg" onclick="procesarCobro()"><i class="fas fa-check"></i> Cobrar</button>
            </div>
        </div>
    </div>

    <!-- Modal Catálogo -->
    <div class="modal-overlay" id="modalCatalogo">
        <div class="modal modal-lg">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-th"></i> Catálogo de Productos</div>
                <button class="btn-close" onclick="cerrarModal('modalCatalogo')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="catalog-search">
                    <i class="fas fa-search"></i>
                    <input type="text" id="catalogoBuscar" placeholder="Buscar producto..." oninput="filtrarCatalogo()">
                </div>
                <div class="catalog-categories" id="catalogoCategorias"></div>
                <div class="catalog-grid" id="catalogoGrid"></div>
            </div>
        </div>
    </div>

    <!-- Modal Cliente -->
    <div class="modal-overlay" id="modalCliente">
        <div class="modal modal-md">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-user-plus"></i> Nuevo Cliente</div>
                <button class="btn-close" onclick="cerrarModal('modalCliente')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-form-grid">
                    <div class="modal-field full">
                        <label>Nombre <span class="required">*</span></label>
                        <input type="text" id="cliNombre" placeholder="Nombre completo">
                    </div>
                    <div class="modal-field">
                        <label>Teléfono</label>
                        <input type="tel" id="cliTelefono" placeholder="10 dígitos">
                    </div>
                    <div class="modal-field">
                        <label>Email</label>
                        <input type="email" id="cliEmail" placeholder="correo@ejemplo.com">
                    </div>
                    <div class="modal-field">
                        <label>RFC</label>
                        <input type="text" id="cliRFC" placeholder="RFC (opcional)">
                    </div>
                    <div class="modal-field">
                        <label>Tipo Precio</label>
                        <select id="cliTipoPrecio">
                            <option value="1">Precio 1 (Público)</option>
                            <option value="2">Precio 2 (Mayoreo)</option>
                            <option value="3">Precio 3 (Distribuidor)</option>
                        </select>
                    </div>
                    <div class="modal-field full">
                        <label>Dirección</label>
                        <textarea id="cliDireccion" rows="2" placeholder="Dirección completa"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalCliente')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarCliente()"><i class="fas fa-save"></i> Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Producto -->
    <div class="modal-overlay" id="modalProducto">
        <div class="modal modal-md">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-box"></i> Nuevo Producto</div>
                <button class="btn-close" onclick="cerrarModal('modalProducto')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="modal-form-grid">
                    <div class="modal-field">
                        <label>Código Barras</label>
                        <input type="text" id="prodCodigo">
                    </div>
                    <div class="modal-field">
                        <label>Código Interno</label>
                        <input type="text" id="prodInterno">
                    </div>
                    <div class="modal-field full">
                        <label>Nombre <span class="required">*</span></label>
                        <input type="text" id="prodNombre">
                    </div>
                    <div class="modal-field">
                        <label>Categoría</label>
                        <select id="prodCategoria"></select>
                    </div>
                    <div class="modal-field">
                        <label>Precio Venta</label>
                        <input type="number" id="prodPrecio" step="0.01" value="0">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalProducto')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarProducto()"><i class="fas fa-save"></i> Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Cambiar Pago -->
    <div class="modal-overlay" id="modalCambiarPago">
        <div class="modal modal-sm">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-exchange-alt"></i> Cambiar Método de Pago</div>
                <button class="btn-close" onclick="cerrarModal('modalCambiarPago')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="cambiarPagoId">
                <div class="form-group">
                    <label>Pago actual</label>
                    <div class="pago-actual-info" id="pagoActualInfo"></div>
                </div>
                <div class="form-group">
                    <label>Nuevo método de pago</label>
                    <select id="nuevoMetodoPago"></select>
                </div>
                <div class="form-group">
                    <label>Referencia (opcional)</label>
                    <input type="text" id="nuevaReferencia" placeholder="Número de referencia">
                </div>
                <div class="form-group">
                    <label>Motivo del cambio</label>
                    <textarea id="motivoCambio" rows="2" placeholder="Explique el motivo..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalCambiarPago')">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarCambioPago()"><i class="fas fa-check"></i> Cambiar</button>
            </div>
        </div>
    </div>

    <!-- Modal Cancelar Producto -->
    <div class="modal-overlay" id="modalCancelarProducto">
        <div class="modal modal-sm">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-times-circle"></i> Cancelar Producto</div>
                <button class="btn-close" onclick="cerrarModal('modalCancelarProducto')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="cancelarDetalleId">
                <div class="producto-cancelar-info" id="productoCancelarInfo"></div>
                <div class="form-group">
                    <label>Cantidad a cancelar</label>
                    <input type="number" id="cantidadCancelar" min="1" step="1" oninput="actualizarDevolucion()">
                </div>
                <div class="form-group">
                    <label>Motivo de cancelación</label>
                    <textarea id="motivoCancelacion" rows="2" placeholder="Motivo..."></textarea>
                </div>
                <div class="devolucion-info" id="devolucionInfo">
                    <span>Devolución:</span>
                    <strong id="montoDevolucion">$0.00</strong>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalCancelarProducto')">Cancelar</button>
                <button class="btn btn-danger" onclick="confirmarCancelarProducto()"><i class="fas fa-times"></i> Cancelar Producto</button>
            </div>
        </div>
    </div>

    <!-- Modal Autorización -->
    <div class="modal-overlay" id="modalAutorizacion">
        <div class="modal modal-sm">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-lock"></i> Autorización Requerida</div>
                <button class="btn-close" onclick="cerrarModal('modalAutorizacion')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p class="auth-message">Esta acción requiere autorización de un supervisor.</p>
                <div class="form-group">
                    <label>Clave de autorización</label>
                    <input type="password" id="claveAutorizacion" placeholder="Ingrese la clave">
                </div>
                <input type="hidden" id="accionPendiente">
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalAutorizacion')">Cancelar</button>
                <button class="btn btn-primary" onclick="validarAutorizacion()"><i class="fas fa-key"></i> Autorizar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script src="../js/api.js"></script>
    <script src="../js/ventas.js"></script>
</body>
</html>

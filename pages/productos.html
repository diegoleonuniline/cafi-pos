<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAFI - Productos</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/catalogos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="admin-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <svg viewBox="0 0 500 500" width="40" height="40">
                    <g transform="translate(0,500) scale(0.1,-0.1)">
                        <path fill="#2D3DBF" d="M905 3775 c-5 -2 -22 -6 -37 -9 -62 -14 -127 -102 -128 -174 0 -43 24 -100 58 -135 39 -41 107 -57 246 -57 l121 0 136 -137 137 -138 59 -145 c33 -80 89 -219 124 -309 l64 -165 7 105 c9 150 39 265 103 394 74 150 174 267 305 357 24 16 16 17 -180 17 l-205 1 -175 176 c-96 96 -193 185 -215 197 -37 20 -56 22 -225 24 -102 1 -189 1 -195 -2z"/>
                        <path fill="#6C2BD9" d="M3270 3352 c143 -112 231 -234 285 -399 14 -43 28 -105 32 -138 9 -98 16 -96 -293 -93 l-259 3 -30 58 c-43 83 -88 133 -148 165 -48 25 -61 27 -172 27 -112 0 -124 -2 -178 -29 -60 -30 -126 -95 -157 -156 -39 -77 -52 -147 -48 -264 3 -104 6 -116 40 -188 78 -163 207 -239 382 -225 135 12 252 97 286 210 23 80 11 77 301 77 l258 0 18 -23 17 -24 40 101 c21 56 99 254 174 441 80 202 135 355 136 377 1 45 -32 84 -83 98 -20 6 -168 10 -336 10 l-300 0 35 -28z"/>
                        <path fill="#fff" d="M2147 1706 c-175 -48 -237 -282 -109 -412 93 -94 263 -88 351 11 46 53 61 93 61 165 0 162 -149 278 -303 236z"/>
                        <path fill="#fff" d="M3058 1706 c-150 -41 -228 -210 -159 -344 79 -154 289 -183 402 -55 43 50 59 92 59 160 -1 163 -150 281 -302 239z"/>
                    </g>
                </svg>
                <span>CAFI</span>
            </div>
            <nav class="sidebar-nav">
                <a href="pos.html" class="nav-item"><i class="fas fa-cash-register"></i><span>Punto de Venta</span></a>
                <a href="admin.html" class="nav-item"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
                <a href="productos.html" class="nav-item active"><i class="fas fa-box"></i><span>Productos</span></a>
                <a href="categorias.html" class="nav-item"><i class="fas fa-tags"></i><span>Categorías</span></a>
                <a href="clientes.html" class="nav-item"><i class="fas fa-users"></i><span>Clientes</span></a>
                <a href="ventas.html" class="nav-item"><i class="fas fa-chart-line"></i><span>Ventas</span></a>
                <a href="reportes.html" class="nav-item"><i class="fas fa-file-alt"></i><span>Reportes</span></a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-mini">
                    <div class="user-avatar" id="userAvatar">AD</div>
                    <div class="user-info">
                        <span id="userName">Usuario</span>
                        <small id="userSucursal">Sucursal</small>
                    </div>
                </div>
                <button class="btn-logout" onclick="API.logout()"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </aside>

        <main class="admin-main">
            <header class="admin-header">
                <h1><i class="fas fa-box"></i> Productos <span class="badge badge-info" id="totalRegistros">0</span></h1>
                <div class="header-actions">
                    <button class="btn btn-outline" onclick="exportarExcel()"><i class="fas fa-file-excel"></i> Exportar</button>
                    <button class="btn btn-primary" onclick="abrirModal()"><i class="fas fa-plus"></i> Nuevo Producto</button>
                </div>
            </header>

            <div class="admin-content">
                <div class="section-card">
                    <div class="filters-bar">
                        <div class="filter-search">
                            <i class="fas fa-search"></i>
                            <input type="text" id="inputBuscar" placeholder="Buscar por nombre o código..." oninput="filtrar()">
                        </div>
                        <select id="filtroCategoria" onchange="filtrar()"><option value="">Todas</option></select>
                        <select id="filtroEstado" onchange="filtrar()">
                            <option value="Y">Activos</option>
                            <option value="N">Inactivos</option>
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nombre</th>
                                <th>Categoría</th>
                                <th>U. Compra</th>
                                <th>U. Venta</th>
                                <th>Factor</th>
                                <th>Costo</th>
                                <th>Precio 1</th>
                                <th>IVA</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaBody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL FORMULARIO CON TABS -->
    <div class="modal-overlay" id="modalForm">
        <div class="modal modal-xl">
            <div class="modal-header gradient">
                <h3><i class="fas fa-box"></i> <span id="modalTitulo">Nuevo Producto</span></h3>
                <button class="btn-close light" onclick="cerrarModal()"><i class="fas fa-times"></i></button>
            </div>
            <form id="formProducto" onsubmit="guardar(event)">
                <input type="hidden" id="editId">
                
                <div class="tabs-container">
                    <div class="tabs-nav">
                        <button type="button" class="tab-btn active" data-tab="general"><i class="fas fa-info-circle"></i> General</button>
                        <button type="button" class="tab-btn" data-tab="unidades"><i class="fas fa-boxes"></i> Unidades</button>
                        <button type="button" class="tab-btn" data-tab="precios"><i class="fas fa-dollar-sign"></i> Precios</button>
                        <button type="button" class="tab-btn" data-tab="impuestos"><i class="fas fa-percentage"></i> Impuestos</button>
                        <button type="button" class="tab-btn" data-tab="inventario"><i class="fas fa-warehouse"></i> Inventario</button>
                        <button type="button" class="tab-btn" data-tab="config"><i class="fas fa-cog"></i> Config</button>
                    </div>

                    <div class="tab-content active" id="tab-general">
                        <div class="form-row">
                            <div class="form-group col-8">
                                <label>Nombre del Producto <span class="required">*</span></label>
                                <input type="text" id="nombre" required placeholder="Ej: Coca Cola 600ml">
                            </div>
                            <div class="form-group col-4">
                                <label>Categoría</label>
                                <select id="categoria_id"><option value="">Sin categoría</option></select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-4">
                                <label>Nombre Corto</label>
                                <input type="text" id="nombre_corto" placeholder="Nombre abreviado" maxlength="50">
                            </div>
                            <div class="form-group col-4">
                                <label>Nombre en POS</label>
                                <input type="text" id="nombre_pos" placeholder="Mostrar en punto de venta" maxlength="50">
                            </div>
                            <div class="form-group col-4">
                                <label>Nombre en Ticket</label>
                                <input type="text" id="nombre_ticket" placeholder="Imprimir en ticket" maxlength="40">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-4">
                                <label>Código de Barras</label>
                                <div class="input-with-icon">
                                    <i class="fas fa-barcode"></i>
                                    <input type="text" id="codigo_barras" placeholder="Escanear o escribir">
                                </div>
                            </div>
                            <div class="form-group col-4">
                                <label>Código Interno (SKU)</label>
                                <input type="text" id="codigo_interno" placeholder="SKU interno">
                            </div>
                            <div class="form-group col-4">
                                <label>Código SAT</label>
                                <input type="text" id="codigo_sat" placeholder="Clave producto SAT">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-12">
                                <label>Descripción</label>
                                <textarea id="descripcion" rows="2" placeholder="Descripción detallada del producto..."></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-4">
                                <label>Tipo</label>
                                <select id="tipo">
                                    <option value="PRODUCTO">Producto</option>
                                    <option value="SERVICIO">Servicio</option>
                                    <option value="COMBO">Combo</option>
                                    <option value="PAQUETE">Paquete</option>
                                </select>
                            </div>
                            <div class="form-group col-4">
                                <label>URL Imagen</label>
                                <input type="url" id="imagen_url" placeholder="https://...">
                            </div>
                            <div class="form-group col-4">
                                <label>Vista Previa</label>
                                <div class="img-preview" id="imgPreview"><i class="fas fa-image"></i></div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="tab-unidades">
                        <div class="info-box info">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <strong>Conversión de Unidades</strong>
                                <p>Define cómo compras y vendes el producto. Ejemplo: Compras una REJA de 24 piezas y vendes por PIEZA.</p>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-4">
                                <label>Unidad de Compra</label>
                                <select id="unidad_compra" onchange="actualizarConversion()">
                                    <option value="PZ">Pieza (PZ)</option>
                                    <option value="CJ">Caja (CJ)</option>
                                    <option value="RJ">Reja (RJ)</option>
                                    <option value="PQ">Paquete (PQ)</option>
                                    <option value="BT">Bulto (BT)</option>
                                    <option value="KG">Kilogramo (KG)</option>
                                    <option value="LT">Litro (LT)</option>
                                    <option value="MT">Metro (MT)</option>
                                    <option value="GL">Galón (GL)</option>
                                </select>
                            </div>
                            <div class="form-group col-4">
                                <label>Factor de Conversión</label>
                                <input type="number" id="factor_conversion" step="0.0001" min="1" value="1" placeholder="1" oninput="actualizarConversion(); calcularCostoUnitario();">
                            </div>
                            <div class="form-group col-4">
                                <label>Unidad de Venta</label>
                                <select id="unidad_venta" onchange="actualizarConversion()">
                                    <option value="PZ">Pieza (PZ)</option>
                                    <option value="KG">Kilogramo (KG)</option>
                                    <option value="LT">Litro (LT)</option>
                                    <option value="MT">Metro (MT)</option>
                                    <option value="GR">Gramo (GR)</option>
                                    <option value="ML">Mililitro (ML)</option>
                                </select>
                            </div>
                        </div>
                        <div class="conversion-box" id="conversionBox">
                            <div class="conversion-visual">
                                <div class="conv-item">
                                    <i class="fas fa-truck"></i>
                                    <span>1</span>
                                    <strong id="convUCompra">PZ</strong>
                                </div>
                                <div class="conv-arrow"><i class="fas fa-equals"></i></div>
                                <div class="conv-item highlight">
                                    <i class="fas fa-shopping-cart"></i>
                                    <span id="convFactor">1</span>
                                    <strong id="convUVenta">PZ</strong>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-6">
                                <label>Unidad de Inventario</label>
                                <select id="unidad_inventario_id">
                                    <option value="PZ">Pieza (PZ)</option>
                                    <option value="KG">Kilogramo (KG)</option>
                                    <option value="LT">Litro (LT)</option>
                                    <option value="MT">Metro (MT)</option>
                                </select>
                            </div>
                            <div class="form-group col-6">
                                <label>Factor Venta</label>
                                <input type="number" id="factor_venta" step="0.0001" min="0.0001" value="1" placeholder="1">
                                <small class="help-text">Para venta a granel. Ej: 0.001 para vender en gramos</small>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="tab-precios">
                        <div class="form-row">
                            <div class="form-group col-6">
                                <label>Costo por Unidad de Compra</label>
                                <div class="input-money">
                                    <span>$</span>
                                    <input type="number" id="costo_compra" step="0.01" placeholder="0.00" oninput="calcularCostoUnitario()">
                                </div>
                                <small class="help-text">Ej: $300.00 por reja</small>
                            </div>
                            <div class="form-group col-6">
                                <label>Costo Unitario <span class="badge-calc">Auto</span></label>
                                <div class="input-money calculated">
                                    <span>$</span>
                                    <input type="number" id="costo" step="0.0001" placeholder="0.00" readonly>
                                </div>
                                <small class="help-text" id="costoFormula">Costo compra ÷ Factor</small>
                            </div>
                        </div>
                        <div class="divider"><span>Precios de Venta</span></div>
                        <div class="form-row">
                            <div class="form-group col-3">
                                <label>Precio 1 (Público) <span class="required">*</span></label>
                                <div class="input-money">
                                    <span>$</span>
                                    <input type="number" id="precio1" step="0.01" placeholder="0.00" required oninput="calcularMargen(1)">
                                </div>
                                <div class="margin-badge" id="margen1">Margen: --%</div>
                            </div>
                            <div class="form-group col-3">
                                <label>Precio 2 (Mayoreo)</label>
                                <div class="input-money">
                                    <span>$</span>
                                    <input type="number" id="precio2" step="0.01" placeholder="0.00" oninput="calcularMargen(2)">
                                </div>
                                <div class="margin-badge" id="margen2">Margen: --%</div>
                            </div>
                            <div class="form-group col-3">
                                <label>Precio 3 (Especial)</label>
                                <div class="input-money">
                                    <span>$</span>
                                    <input type="number" id="precio3" step="0.01" placeholder="0.00" oninput="calcularMargen(3)">
                                </div>
                                <div class="margin-badge" id="margen3">Margen: --%</div>
                            </div>
                            <div class="form-group col-3">
                                <label>Precio 4</label>
                                <div class="input-money">
                                    <span>$</span>
                                    <input type="number" id="precio4" step="0.01" placeholder="0.00" oninput="calcularMargen(4)">
                                </div>
                                <div class="margin-badge" id="margen4">Margen: --%</div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-4">
                                <label>Precio Mínimo</label>
                                <div class="input-money">
                                    <span>$</span>
                                    <input type="number" id="precio_minimo" step="0.01" placeholder="0.00">
                                </div>
                                <small class="help-text">No vender por debajo de este precio</small>
                            </div>
                            <div class="form-group col-4">
                                <label>Último Costo</label>
                                <div class="input-money readonly">
                                    <span>$</span>
                                    <input type="number" id="ultimo_costo" step="0.01" placeholder="0.00" readonly>
                                </div>
                            </div>
                            <div class="form-group col-4">
                                <label>Costo Promedio</label>
                                <div class="input-money readonly">
                                    <span>$</span>
                                    <input type="number" id="costo_promedio" step="0.01" placeholder="0.00" readonly>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="tab-impuestos">
                        <div class="form-row">
                            <div class="form-group col-6">
                                <label>IVA</label>
                                <div class="radio-cards">
                                    <label class="radio-card">
                                        <input type="radio" name="iva" value="0">
                                        <div class="card-content">
                                            <span class="percentage">0%</span>
                                            <span class="label">Exento</span>
                                        </div>
                                    </label>
                                    <label class="radio-card">
                                        <input type="radio" name="iva" value="8">
                                        <div class="card-content">
                                            <span class="percentage">8%</span>
                                            <span class="label">Frontera</span>
                                        </div>
                                    </label>
                                    <label class="radio-card active">
                                        <input type="radio" name="iva" value="16" checked>
                                        <div class="card-content">
                                            <span class="percentage">16%</span>
                                            <span class="label">General</span>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group col-6">
                                <label>IEPS (%)</label>
                                <div class="input-percent">
                                    <input type="number" id="ieps" step="0.01" min="0" placeholder="0" value="0">
                                    <span>%</span>
                                </div>
                                <small class="help-text">Impuesto Especial sobre Producción y Servicios</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-12">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="precio_incluye_impuesto" checked>
                                    <span class="slider"></span>
                                    <span class="toggle-label">
                                        <strong>Precio incluye impuestos</strong>
                                        <small>Si está activo, los precios ya incluyen IVA e IEPS</small>
                                    </span>
                                </label>
                            </div>
                        </div>
                        <div class="tax-summary" id="taxSummary">
                            <h4>Resumen de Impuestos (Precio 1)</h4>
                            <div class="tax-row">
                                <span>Precio sin impuestos:</span>
                                <strong id="precioSinImp">$0.00</strong>
                            </div>
                            <div class="tax-row">
                                <span>IVA (<span id="ivaPercent">16</span>%):</span>
                                <strong id="ivaAmount">$0.00</strong>
                            </div>
                            <div class="tax-row">
                                <span>IEPS (<span id="iepsPercent">0</span>%):</span>
                                <strong id="iepsAmount">$0.00</strong>
                            </div>
                            <div class="tax-row total">
                                <span>Precio Final:</span>
                                <strong id="precioFinal">$0.00</strong>
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="tab-inventario">
                        <div class="form-row">
                            <div class="form-group col-4">
                                <label>Stock Mínimo</label>
                                <input type="number" id="stock_minimo" step="0.001" min="0" placeholder="0">
                                <small class="help-text">Alerta cuando llegue a este nivel</small>
                            </div>
                            <div class="form-group col-4">
                                <label>Stock Máximo</label>
                                <input type="number" id="stock_maximo" step="0.001" min="0" placeholder="0">
                            </div>
                            <div class="form-group col-4">
                                <label>Punto de Reorden</label>
                                <input type="number" id="punto_reorden" step="0.001" min="0" placeholder="0">
                                <small class="help-text">Generar orden de compra</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-6">
                                <label>Ubicación en Almacén</label>
                                <input type="text" id="ubicacion_almacen" placeholder="Ej: Pasillo 3, Anaquel B">
                            </div>
                        </div>
                        <div class="divider"><span>Control Especial</span></div>
                        <div class="form-row">
                            <div class="form-group col-4">
                                <label class="toggle-switch small">
                                    <input type="checkbox" id="maneja_lotes">
                                    <span class="slider"></span>
                                    <span class="toggle-label">Maneja Lotes</span>
                                </label>
                            </div>
                            <div class="form-group col-4">
                                <label class="toggle-switch small">
                                    <input type="checkbox" id="maneja_caducidad">
                                    <span class="slider"></span>
                                    <span class="toggle-label">Maneja Caducidad</span>
                                </label>
                            </div>
                            <div class="form-group col-4">
                                <label class="toggle-switch small">
                                    <input type="checkbox" id="maneja_series">
                                    <span class="slider"></span>
                                    <span class="toggle-label">Maneja Series</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-row" id="rowCaducidad" style="display:none">
                            <div class="form-group col-4">
                                <label>Días antes de caducidad (alerta)</label>
                                <input type="number" id="dias_caducidad" min="0" placeholder="30">
                            </div>
                        </div>
                    </div>

                    <div class="tab-content" id="tab-config">
                        <div class="form-row">
                            <div class="form-group col-6">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="es_inventariable" checked>
                                    <span class="slider"></span>
                                    <span class="toggle-label">
                                        <strong>Es Inventariable</strong>
                                        <small>Controlar existencias en almacén</small>
                                    </span>
                                </label>
                            </div>
                            <div class="form-group col-6">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="es_vendible" checked>
                                    <span class="slider"></span>
                                    <span class="toggle-label">
                                        <strong>Es Vendible</strong>
                                        <small>Mostrar en punto de venta</small>
                                    </span>
                                </label>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-6">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="es_comprable" checked>
                                    <span class="slider"></span>
                                    <span class="toggle-label">
                                        <strong>Es Comprable</strong>
                                        <small>Disponible para órdenes de compra</small>
                                    </span>
                                </label>
                            </div>
                            <div class="form-group col-6">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="mostrar_pos" checked>
                                    <span class="slider"></span>
                                    <span class="toggle-label">
                                        <strong>Mostrar en POS</strong>
                                        <small>Visible en pantalla de ventas</small>
                                    </span>
                                </label>
                            </div>
                        </div>
                        <div class="divider"><span>Descuentos</span></div>
                        <div class="form-row">
                            <div class="form-group col-6">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="permite_descuento" checked>
                                    <span class="slider"></span>
                                    <span class="toggle-label">
                                        <strong>Permite Descuento</strong>
                                        <small>Autorizar descuentos en este producto</small>
                                    </span>
                                </label>
                            </div>
                            <div class="form-group col-6">
                                <label>Descuento Máximo (%)</label>
                                <div class="input-percent">
                                    <input type="number" id="descuento_maximo" min="0" max="100" placeholder="0" value="100">
                                    <span>%</span>
                                </div>
                            </div>
                        </div>
                        <div class="divider"><span>POS</span></div>
                        <div class="form-row">
                            <div class="form-group col-4">
                                <label>Color en POS</label>
                                <div class="color-picker">
                                    <input type="color" id="color_pos" value="#3498db">
                                    <input type="text" id="color_pos_text" value="#3498db" onchange="document.getElementById('color_pos').value=this.value">
                                </div>
                            </div>
                            <div class="form-group col-4">
                                <label>Orden en POS</label>
                                <input type="number" id="orden_pos" min="0" placeholder="0" value="0">
                            </div>
                            <div class="form-group col-4">
                                <label>Tecla Rápida</label>
                                <input type="text" id="tecla_rapida" placeholder="Ej: F5" maxlength="10">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-12">
                                <label>Notas Internas</label>
                                <textarea id="notas_internas" rows="2" placeholder="Notas solo visibles para administradores..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="cerrarModal()"><i class="fas fa-times"></i> Cancelar</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Guardar Producto</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="toast"></div>
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/productos.js"></script>
</body>
</html>
